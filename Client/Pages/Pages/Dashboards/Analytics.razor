@page "/"
@page "/analytics"

@inject IJSRuntime JsRuntime;
@inject HttpClient Http; // Inject the DbContext
@implements IDisposable // Required for DotNetObjectReference cleanup

<PageBreadcrumb Title="Analytics" SubTitle="Dashboards"/>

<div class="row">
    <div class="col-xxl-3">
        <div class="row">
            <div class="col-md-6 col-xxl-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div
                                    class="avatar-md bg-primary bg-opacity-10 rounded">
                                    <iconify-icon
                                        icon="iconamoon:eye-duotone"
                                        class="avatar-title text-primary fs-32">
                                    </iconify-icon>
                                </div>
                            </div>
                            <!-- end col -->
                            <div class="col-6 text-end">
                                <p
                                    class="text-muted mb-0 text-truncate">
                                    Inspections
                                </p>
                                <h3
                                    class="text-dark mt-1 mb-0">
                                    13,647
                                </h3>
                            </div>
                            <!-- end col -->
                        </div>
                        <!-- end row-->
                    </div>
                    <!-- end card body -->
                </div>
                <!-- end card -->
            </div>
            <!-- end col -->
            <div class="col-md-6 col-xxl-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div
                                    class="avatar-md bg-success bg-opacity-10 rounded">
                                    <iconify-icon
                                        icon="iconamoon:link-external-duotone"
                                        class="avatar-title text-success fs-32">
                                    </iconify-icon>
                                </div>
                            </div>
                            <!-- end col -->
                            <div class="col-6 text-end">
                                <p
                                    class="text-muted mb-0 text-truncate">
                                    Certifications
                                </p>
                                <h3
                                    class="text-dark mt-1 mb-0">
                                    9,526
                                </h3>
                            </div>
                            <!-- end col -->
                        </div>
                        <!-- end row-->
                    </div>
                    <!-- end card body -->
                </div>
                <!-- end card -->
            </div>
            <!-- end col -->
            <div class="col-md-6 col-xxl-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div
                                    class="avatar-md bg-danger bg-opacity-10 rounded">
                                    <iconify-icon
                                        icon="iconamoon:trend-up-bold"
                                        class="avatar-title text-danger fs-32">
                                    </iconify-icon>
                                </div>
                            </div>
                            <!-- end col -->
                            <div class="col-6 text-end">
                                <p
                                    class="text-muted mb-0 text-truncate">
                                    Reductions
                                </p>
                                <h3
                                    class="text-dark mt-1 mb-0">
                                    65.2%
                                </h3>
                            </div>
                            <!-- end col -->
                        </div>
                        <!-- end row-->
                    </div>
                    <!-- end card body -->
                </div>
                <!-- end card -->
            </div>
            <!-- end col -->
            <div class="col-md-6 col-xxl-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div
                                    class="avatar-md bg-warning bg-opacity-10 rounded">
                                    <iconify-icon
                                        icon="iconamoon:profile-circle-duotone"
                                        class="avatar-title text-warning fs-32">
                                    </iconify-icon>
                                </div>
                            </div>
                            <!-- end col -->
                            <div class="col-6 text-end">
                                <p
                                    class="text-muted mb-0 text-truncate">
                                    Routes
                                </p>
                                <h3
                                    class="text-dark mt-1 mb-0">
                                    9.5k
                                </h3>
                            </div>
                            <!-- end col -->
                        </div>
                        <!-- end row-->
                    </div>
                    <!-- end card body -->
                </div>
                <!-- end card -->
            </div>
            <!-- end col -->
        </div>
        <!-- end row -->
    </div>
    <!-- end col -->
    <div class="col-xxl-9">
        <div class="card">
            <div class="card-body p-0">
                <div class="row g-0">
                    <div class="col-lg-4">
                        <div class="p-3">
                            <h5 class="card-title">
                               Defensive Actions Success
                            </h5>
                            <div
                                id="conversions"
                                class="apex-charts mb-2 mt-n2">
                            </div>
                            <div class="row text-center">
                                <div class="col-6">
                                    <p
                                        class="text-muted mb-2">
                                        This Week
                                    </p>
                                    <h3
                                        class="text-dark mb-3">
                                        85%
                                    </h3>
                                </div>
                                <!-- end col -->
                                <div class="col-6">
                                    <p
                                        class="text-muted mb-2">
                                        Last Week
                                    </p>
                                    <h3
                                        class="text-dark mb-3">
                                        80%
                                    </h3>
                                </div>
                                <!-- end col -->
                            </div>
                            <!-- end row -->
                            <div class="text-center">
                                <button
                                    type="button"
                                    class="btn btn-light shadow-none w-100">
                                    View Details
                                </button>
                            </div>
                            <!-- end row -->
                        </div>
                    </div>
                    <!-- end left chart card -->
                    <div class="col-lg-8 border-start">
                        <div class="p-3">
                            <div
                                class="d-flex justify-content-between align-items-center">
                                <h4 class="card-title">
                                    Fleet Safety Performance
                                </h4>
                                <div>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-light">
                                        ALL
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-light">
                                        1M
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-light">
                                        6M
                                    </button>
                                    <button
                                        type="button"
                                        class="btn btn-sm btn-outline-light active">
                                        1Y
                                    </button>
                                </div>
                            </div>
                            <!-- end card-title-->

                            <!--<div
                                class="alert alert-info mt-3 text text-truncate mb-0"
                                role="alert">
                                We regret to inform you that
                                our server is currently
                                experiencing technical
                                difficulties.
                            </div>-->

                            <div dir="ltr">
                                <div
                                    id="dash-performance-chart"
                                    class="apex-charts">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end right chart card -->
                </div>
                <!-- end chart card -->
            </div>
            <!-- end card body -->
        </div>
        <!-- end card -->
    </div>
    <!-- end col -->
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div
                class="d-flex card-header justify-content-between align-items-center border-bottom border-dashed">
                <h4 class="card-title">
                    Regional Fleet Safety Performance
                </h4>
                <div class="dropdown">
                    <a
                        href="#"
                        class="dropdown-toggle btn btn-sm btn-outline-light"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                        View Data
                    </a>
                    <div
                        class="dropdown-menu dropdown-menu-end">
                        <!-- item-->
                        <a
                            href="javascript:void(0);"
                            class="dropdown-item">
                            Download
                        </a>
                        <!-- item-->
                        <a
                            href="javascript:void(0);"
                            class="dropdown-item">
                            Export
                        </a>
                        <!-- item-->
                        <a
                            href="javascript:void(0);"
                            class="dropdown-item">
                            Import
                        </a>
                    </div>
                </div>
            </div>

            <div class="card-body pt-0">
                <div class="row align-items-center">
                    <div class="col-lg-7">
                        <div
                            id="world-map-markers"
                            class="my-3"
                            style="height: 300px">
                        </div>
                    </div>
                    <div class="col-lg-5" dir="ltr">
                        <div class="p-3">
                            <!-- Country Data -->
                            <div
                                class="d-flex justify-content-between align-items-center">
                                <p class="mb-1">
                                    <iconify-icon
                                        icon="circle-flags:us"
                                        class="fs-16 align-middle me-1">
                                    </iconify-icon>
                                    <span
                                        class="align-middle">
                    United States
                </span>
                                </p>
                            </div>
                            <div
                                class="row align-items-center mb-3">
                                <div class="col">
                                    <div
                                        class="progress progress-soft progress-sm">
                                        <div
                                            class="progress-bar bg-secondary"
                                            role="progressbar"
                                            style="
                                                                    width: 82.05%;
                                                                "
                                            aria-valuenow=""
                                            aria-valuemin="0"
                                            aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <p
                                        class="mb-0 fs-13 fw-semibold">
                                        659k
                                    </p>
                                </div>
                            </div>

                            <!-- Country Data -->
                            <div
                                class="d-flex justify-content-between align-items-center">
                                <p class="mb-1">
                                    <iconify-icon
                                        icon="circle-flags:ru"
                                        class="fs-16 align-middle me-1">
                                    </iconify-icon>
                                    <span
                                        class="align-middle">
                    Russia
                </span>
                                </p>
                            </div>
                            <div
                                class="row align-items-center mb-3">
                                <div class="col">
                                    <div
                                        class="progress progress-soft progress-sm">
                                        <div
                                            class="progress-bar bg-info"
                                            role="progressbar"
                                            style="width: 70.5%;"
                                            aria-valuenow=""
                                            aria-valuemin="0"
                                            aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <p
                                        class="mb-0 fs-13 fw-semibold">
                                        485k
                                    </p>
                                </div>
                            </div>

                            <!-- Country Data -->
                            <div
                                class="d-flex justify-content-between align-items-center">
                                <p class="mb-1">
                                    <iconify-icon
                                        icon="circle-flags:cn"
                                        class="fs-16 align-middle me-1">
                                    </iconify-icon>
                                    <span
                                        class="align-middle">
                    China
                </span>
                                </p>
                            </div>
                            <div
                                class="row align-items-center mb-3">
                                <div class="col">
                                    <div
                                        class="progress progress-soft progress-sm">
                                        <div
                                            class="progress-bar bg-warning"
                                            role="progressbar"
                                            style="width: 65.8%;"
                                            aria-valuenow=""
                                            aria-valuemin="0"
                                            aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <p
                                        class="mb-0 fs-13 fw-semibold">
                                        355k
                                    </p>
                                </div>
                            </div>

                            <!-- Country Data -->
                            <div
                                class="d-flex justify-content-between align-items-center">
                                <p class="mb-1">
                                    <iconify-icon
                                        icon="circle-flags:ca"
                                        class="fs-16 align-middle me-1">
                                    </iconify-icon>
                                    <span
                                        class="align-middle">
                    Canada
                </span>
                                </p>
                            </div>
                            <div
                                class="row align-items-center mb-3">
                                <div class="col">
                                    <div
                                        class="progress progress-soft progress-sm">
                                        <div
                                            class="progress-bar bg-success"
                                            role="progressbar"
                                            style="
                                                                    width: 55.8%;
                                                                "
                                            aria-valuenow=""
                                            aria-valuemin="0"
                                            aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <p
                                        class="mb-0 fs-13 fw-semibold">
                                        204k
                                    </p>
                                </div>
                            </div>

                            <!-- Country Data -->
                            <div
                                class="d-flex justify-content-between align-items-center">
                                <p class="mb-1">
                                    <iconify-icon
                                        icon="circle-flags:br"
                                        class="fs-16 align-middle me-1">
                                    </iconify-icon>
                                    <span
                                        class="align-middle">
                    Brazil
                </span>
                                </p>
                            </div>
                            <div
                                class="row align-items-center">
                                <div class="col">
                                    <div
                                        class="progress progress-soft progress-sm">
                                        <div
                                            class="progress-bar"
                                            role="progressbar"
                                            style="
                                                                    width: 35.9%;
                                                                "
                                            aria-valuenow=""
                                            aria-valuemin="0"
                                            aria-valuemax="100">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <p
                                        class="mb-0 fs-13 fw-semibold">
                                        109k
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end card-body-->
        </div>
        <!-- end card-->
    </div>
    <!-- end col-->
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="card">
            <div
                class="d-flex card-header justify-content-between align-items-center border-bottom border-dashed">
                <h4 class="card-title">
                    Performance by Vehicle Type
                </h4>
                <div class="dropdown">
                    <a
                        href="#"
                        class="dropdown-toggle arrow-none card-drop"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <iconify-icon
                            icon="iconamoon:menu-kebab-vertical-circle-duotone"
                            class="fs-20 align-middle text-muted">
                        </iconify-icon>
                    </a>
                    <div
                        class="dropdown-menu dropdown-menu-end">
                        <!-- item-->
                        <a
                            href="javascript:void(0);"
                            class="dropdown-item">
                            Download
                        </a>
                        <!-- item-->
                        <a
                            href="javascript:void(0);"
                            class="dropdown-item">
                            Export
                        </a>
                        <!-- item-->
                        <a
                            href="javascript:void(0);"
                            class="dropdown-item">
                            Import
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body py-2 px-0">
                <div
                    class="px-2"
                    data-simplebar
                    style="height: 270px">
                    <div
                        class="d-flex justify-content-between align-items-center p-2">
                    <span class="align-middle fw-medium">
                            Light-Duty Vehicles (LDV)
                    </span>
                        <span class="fw-semibold text-muted">
                        62.5%
                    </span>
                        <span class="fw-semibold text-muted">
                        5.06k
                    </span>
                    </div>

                    <div
                        class="d-flex justify-content-between align-items-center p-2">
                    <span class="align-middle fw-medium">
                            Medium-Duty Vehicles (MDV)
                    </span>
                        <span class="fw-semibold text-muted">
                        12.3%
                    </span>
                        <span class="fw-semibold text-muted">
                        1.5k
                    </span>
                    </div>

                    <div
                        class="d-flex justify-content-between align-items-center p-2">
                    <span class="align-middle fw-medium">
                            Heavy-Duty Vehicles (HDV)
                    </span>
                        <span class="fw-semibold text-muted">
                        9.86%
                    </span>
                        <span class="fw-semibold text-muted">
                        1.03k
                    </span>
                    </div>

                    <div
                        class="d-flex justify-content-between align-items-center p-2">
                    <span class="align-middle fw-medium">
                            Service / Utility Vehicles
                    </span>
                        <span class="fw-semibold text-muted">
                        3.15%
                    </span>
                        <span class="fw-semibold text-muted">
                        0.3k
                    </span>
                    </div>

                    <div
                        class="d-flex justify-content-between align-items-center p-2">
                    <span class="align-middle fw-medium">
                            Passenger Vans / Shuttle Buses
                    </span>
                        <span class="fw-semibold text-muted">
                        3.01%
                    </span>
                        <span class="fw-semibold text-muted">
                        1.58k
                    </span>
                    </div>

                    <div
                        class="d-flex justify-content-between align-items-center p-2">
                    <span class="align-middle fw-medium">
                            Site Transport Vehicles
                    </span>
                        <span class="fw-semibold text-muted">
                        2.8%
                    </span>
                        <span class="fw-semibold text-muted">
                        0.01k
                    </span>
                    </div>

                    <div
                        class="d-flex justify-content-between align-items-center p-2">
                    <span class="align-middle fw-medium">
                            Flatbeds & Equipment Haulers
                    </span>
                        <span class="fw-semibold text-muted">
                        6.38%
                    </span>
                        <span class="fw-semibold text-muted">
                        3.6k
                    </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card">
            <div
                class="card-header d-flex align-items-center justify-content-between gap-2">
                <h4 class="card-title flex-grow-1">
                    Top Fleet Performance
                </h4>
                <div>
                    <a
                        href="#"
                        class="btn btn-sm btn-soft-primary">
                        View All
                    </a>
                </div>
            </div>
            <div class="table-responsive">
                <table
                    class="table table-hover table-nowrap table-centered m-0">
                    <thead class="bg-light bg-opacity-50">
                    <tr>
                        <th class="text-muted py-1">
                            Region
                        </th>
                        <th class="text-muted py-1">
                            Total Performance Index
                        </th>
                        <th class="text-muted py-1">
                            Dedication Index
                        </th>
                        <th class="text-muted py-1">
                            Incident Reduction
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>
                            <a
                                href="#"
                                class="text-muted">
                                Toronto, Canada
                            </a>
                        </td>
                        <td>4265</td>
                        <td>09m:45s</td>
                        <td>
                        <span
                            class="badge badge-soft-danger">
                            20.4%
                        </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <a
                                href="#"
                                class="text-muted">
                                New York, U.S.
                            </a>
                        </td>
                        <td>2584</td>
                        <td>05m:02s</td>
                        <td>
                        <span
                            class="badge badge-soft-warning">
                            12.25%
                        </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <a
                                href="#"
                                class="text-muted">
                                Moscow, Russia
                            </a>
                        </td>
                        <td>3369</td>
                        <td>04m:25s</td>
                        <td>
                        <span
                            class="badge badge-soft-success">
                            5.2%
                        </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <a
                                href="#"
                                class="text-muted">
                                Buenos Aires, Brazil
                            </a>
                        </td>
                        <td>985</td>
                        <td>02m:03s</td>
                        <td>
                        <span
                            class="badge badge-soft-danger">
                            64.2%
                        </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <a
                                href="#"
                                class="text-muted">
                                Guangzhou, China
                            </a>
                        </td>
                        <td>653</td>
                        <td>15m:56s</td>
                        <td>
                        <span
                            class="badge badge-soft-success">
                            2.4%
                        </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@code {
    private IJSObjectReference? _module;
    // Object reference for JS interop, used to call C# from JS
    private DotNetObjectReference<Analytics>? _dotNetRef;

        /*protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/pages/dashboard.analytics.js");
            await JsRuntime.InvokeVoidAsync("loadAnalytics");
            await JsRuntime.InvokeVoidAsync("loadTheme");
            await JsRuntime.InvokeVoidAsync("loadApps");
        }
    }*/

    //private IJSObjectReference? _module;
    // Object reference for JS interop, used to call C# from JS
    protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            if (firstRender)
            {
                // Create the object reference
                _dotNetRef = DotNetObjectReference.Create(this);

                // Import the JS module
                _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/pages/dashboard.analytics.js");

                // Pass the DotNetObjectReference to the JavaScript function
                await JsRuntime.InvokeVoidAsync("loadAnalytics", _dotNetRef);

                // These calls were present in your original code
                await JsRuntime.InvokeVoidAsync("loadTheme");
                await JsRuntime.InvokeVoidAsync("loadApps");
            }
        }

        // This method is called from JavaScript (in dashboard.analytics.js)
        [JSInvokable]
        public async Task<int> GetTotalReputation()
        {
                    try
                    {
                        // NEW LOGIC: Call the API endpoint we assume you will create on the Server project.
                        // We expect the server to return a single integer value (the sum).
                        var totalReputation = await Http.GetFromJsonAsync<int>("api/Sim/TotalReputation");
                        return totalReputation;
                    }
                    catch (Exception ex)
                    {
                        // Log the exception, which is likely a network or deserialization error
                        Console.WriteLine($"Error fetching total reputation via HTTP: {ex.Message}");
                        return 0;
                    }
        }

        // Standard Blazor lifecycle method for cleaning up IDisposable resources
        public void Dispose()
        {
            _dotNetRef?.Dispose();
        }

}